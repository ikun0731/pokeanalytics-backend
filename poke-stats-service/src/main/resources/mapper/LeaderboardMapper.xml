<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 
    排行榜数据库操作映射文件
    提供复杂的SQL查询，用于获取宝可梦使用率排行榜数据
-->
<mapper namespace="com.pokeanalytics.pokestatsservice.mapper.LeaderboardMapper">

    <!-- 
        获取宝可梦使用率排行榜
        参数:
        - snapshotId: 统计快照ID
        - format: 对战格式
        返回:
        - 宝可梦使用率排行榜数据，包含基本信息和最常用道具
    -->
    <select id="getLeaderboard" resultType="com.pokeanalytics.pokestatsservice.dto.projection.LeaderboardProjection">
        SELECT
            ps.rank,
            pi.id AS pokemonId,
            IFNULL(pi.name_cn, ps.pokemon_name_en) AS nameCn,
            pi.types_cn AS typesCn,
            pi.sprite_pixel AS spritePixel,
            pt.tier,
            ps.usage_rate AS usageRate,
            ps.pokemon_name_en AS NameEn,
            IFNULL(i.item_name_cn, i.item_name) AS topItem
        FROM
            pokemon_usage_stats ps
                LEFT JOIN
            pokemon_info pi ON pi.name_en = ps.pokemon_name_en
                LEFT JOIN
            pokemon_tier pt ON pt.pokemon_name_en = ps.pokemon_name_en AND pt.format = #{format}
                LEFT JOIN
            (
                SELECT 
                    ud.stats_id,
                    ud.detail_name as item_name,
                    ii.name_cn as item_name_cn
                FROM
                    (
                        SELECT 
                            stats_id, 
                            detail_name,
                            ROW_NUMBER() OVER(PARTITION BY stats_id ORDER BY usage_percentage DESC) as rn
                        FROM 
                            usage_details 
                        WHERE 
                            detail_type = 'item' AND
                            stats_id IN (SELECT id FROM pokemon_usage_stats WHERE snapshot_id = #{snapshotId})
                    ) ud
                    LEFT JOIN
                    item_info ii ON REPLACE(REPLACE(LOWER(ii.name_en), ' ', ''), '-', '') = 
                                    REPLACE(REPLACE(LOWER(ud.detail_name), ' ', ''), '-', '')
                WHERE
                    ud.rn = 1
            ) i ON ps.id = i.stats_id
        WHERE
            ps.snapshot_id = #{snapshotId}
        ORDER BY
            ps.usage_rate DESC,
            FIELD(pt.tier, 'AG', 'Uber', 'OU', 'UUBL', 'UU', 'RUBL', 'RU', 'NUBL', 'NU', 'PUBL', 'PU', 'NFE', 'LC'),
            pi.id ASC
    </select>

</mapper>