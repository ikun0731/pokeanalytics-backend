<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 
    技能数据库操作映射文件
    提供对move表的查询操作和关联查询
-->
<mapper namespace="com.pokeanalytics.pokedexdataservice.mapper.MoveMapper">

    <!-- 
        查询技能列表，支持关键词搜索
        参数:
        - keyword: 搜索关键词（可选），用于匹配技能中文名或英文名
        返回:
        - 匹配的技能列表，包含基本信息和属性
    -->
    <select id="findMoveList" resultType="com.pokeanalytics.pokedexdataservice.entity.Move">
        SELECT
            id,
            name_cn,
            name_en,
            type,
            type_cn,
            power,
            pp,
            accuracy,
            flavor_text,
            damage_class,
            damage_class_cn
        FROM
            move
        <!-- 动态WHERE条件，只有当keyword不为空时才添加条件 -->
        <where>
            <if test="keyword != null and keyword.trim() != ''">
                <!-- 模糊匹配中文名或英文名 -->
                (name_cn LIKE CONCAT('%', #{keyword}, '%') OR name_en LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
        ORDER BY
            id ASC
    </select>

    <!-- 
        根据技能ID查询能学会该技能的宝可梦列表
        参数:
        - moveId: 技能ID
        返回:
        - 能学会该技能的宝可梦列表，包含基本信息和学习方式
    -->
    <select id="findPokemonLearnersByMoveId" resultType="com.pokeanalytics.pokedexdataservice.dto.projection.MoveLearnerProjection">
        SELECT
            p.id AS pokemonId,
            p.name_cn AS pokemonNameCn,
            p.sprite_pixel AS spritePixel,
            pm.learn_method AS learnMethod,
            pm.level_learned_at AS levelLearnedAt,
            pm.last_learn_generation AS lastLearnGeneration
        FROM
            pokemon_move pm
                JOIN
            pokemon p ON pm.pokemon_id = p.id
        WHERE
            pm.move_id = #{moveId}
          AND (p.is_default = 1 OR p.is_default IS NULL)
        ORDER BY
            pm.learn_method, p.id
    </select>
</mapper>